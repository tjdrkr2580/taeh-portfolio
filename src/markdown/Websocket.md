---
title: Websocket
date: 2023-04-08 04:27
tag: ["개념"]
desc: 웹/앱에서 별다른 소프트웨어 없이 카메라, 마이크 등을 통한 실시간 커뮤니케이션을 제공해주는 기술. 필수 개념은 잠시 제쳐두고 webRTC 기술에 대한 것만 서술해놓자.
---

> 두 프로그램 간의 메시지를 교환하기 위한 통신 방법 중 하나.

웹 서버와 웹 브라우저가 지속적으로 연결된 TCP (연결성) 라인을 통해 실시간 데이터를
주고 받을 수 있도록 하는 HTML5의 사양이다.

따라서 webSocket을 사용하면 일반적인 TCP 소켓과 같이 연결지향의 양방향
전이중 통신이 가능하다고 하다.

매우 짧은 대기 시간과 높은 볼륨이 필요한 경우에 매우 효과적인 대책이 될 수 있다.

### Websocket의 특징

1. 양방향 통신

- 데이터의 송수신을 동시에 처리할 수 있는 통신 방법.
- 클라이언트, 서버가 서로 원할 때 데이터를 주고 받을 수 있음.
- 통상적인 HTTP 통신 (예로 REST API를 이용한) 은 client가 요청을 보내는 경우에만 Server가 응답하는 단방향 통신

2. 실시간 네트워킹 (Realtime-Networking)

- 웹 환경에서 연속된 데이터를 빠르게 노출시킬 수 있음.
- Ex ) 채팅, 주식 , 비디오 데이터등.

3. Stateful Protocol

- 서버와 클라이언트와 한번 연결이 되면 같은 라인을 사용하여 통신해서 필요없이 발생되는 트래픽을 피할 수 있다고 한다.

4. 단점

- 부하가 발생할 수 있고, 비정상적으로 연결이 끊겼을 때 적절하게 대응할 수 있어야 한다.
- Stateful 하기 때문에 서버, 클라이언트는 연결을 상시 유지해야 한다.

### Websocket 이전의 비슷한 기술

**Polling**

- 서버로 일정 주기 요청 송신
- Realtime 통신에서는 언제 통신이 발생할지 예측이 불가능함.
- 불필요한 request와 connection을 생성함.

**Long Polling**

- 서버에 요청을 보내고 이벤트가 생겨 응답 받을 때 까지 연결 종료 X
- 응답 받으면 끊고 다시 재요청
- 많은 양의 메시지가 쏟아질 경우 결국 Polling과 같음.

결과론적으로 이 모든 방법이 HTTP를 통해 통신하기에 Request, Response 둘 다
불필요하게 크다고 함.

### websocket의 동작 방법 - 핸드 쉐이킹

```

ChatGPT

1. 클라이언트에서 서버로 웹소켓 연결 요청(Handshake Request)을 보냅니다. 이 요청은 일반 HTTP 요청과 동일한 형태를 가지고 있습니다.

2.  서버는 클라이언트에서 보낸 웹소켓 연결 요청을 받아들이고, 응답(Handshake Response)으로 HTTP 응답을 보냅니다. 이 응답에는 웹소켓 연결을 위한 추가적인 정보가 포함되어 있습니다.

3.  클라이언트는 서버에서 보낸 웹소켓 연결 응답을 받아들이고, 추가적인 정보를 확인합니다. 이후 클라이언트와 서버 간의 연결이 설정됩니다.

4.  클라이언트와 서버 간의 웹소켓 연결이 설정된 이후에는, 클라이언트와 서버 간의 양방향 통신이 가능합니다.

```

websocket도 HTTP와 HTTPS 프로토콜을 사용한다.
반드시 Get Method를 사용해야 하고, HTTP의 버전은 1.1이상 이여야 한다.

1. Opening HandShake
   웹소켓 클라이언트에서 핸드쉐이크 요청 (HTTP Upgrade)를 전송하고 이에 대한 응답으로 핸드 셰이크 응답을 받는데, 이때 응답 코드는 101이고 101은 `프로토콜 전환`을 서버가 승인했음을 알리는 코드라고 한다.

Upgrade

- 프로토콜을 전환하기 위한 헤더
- 웹소캣 요청 시에 반드시 websocket 이라는 값을 가지며, 이 값이 없거나 다른 값이면, 프로토콜 어택이라고 간주해서 웹소켓 접속을 중지시킨다.

Connection

- 현재의 전송이 완료된 후 네트워크 접속을 유지할 것인가에 대한 정보.
- 웹소캣 요청 시 반드시 Upgrade 라는 값을 가지며, Upgrade와 마찬가지로 이 값이 없거나 다른 값일 경우 웹소켓 접속을 중지시킴.

Sec-WebSocket-Key

- 유효한 요청인지 확인하기 위해 사용하는 키 값

Sec-WebSocket-Protocol

- 필요한 경우에만 사용, 사용하고자 하는 하나 이상의 웹 소켓 프로토콜 지정.

Sec-WebSocket-Version

- 클라이언트가 사용하고자 하는 웹소켓 프로토콜 버전.

```
-   클라이언트에서 서버로 보내는 요청:
    -   GET 메서드로 요청을 보내며, HTTP 버전은 1.1을 사용합니다.
    -   Upgrade 헤더에 "websocket" 값을 포함시킵니다.
    -   Connection 헤더에 "Upgrade" 값을 포함시킵니다.
    -   Sec-WebSocket-Key 헤더에 랜덤한 문자열 값을 포함시킵니다.
    -   Sec-WebSocket-Version 헤더에 사용하는 웹소켓 버전을 포함시킵니다.

-   서버에서 클라이언트로 보내는 응답:
    -   HTTP 버전은 1.1을 사용합니다.
    -   Upgrade 헤더에 "websocket" 값을 포함시킵니다.
    -   Connection 헤더에 "Upgrade" 값을 포함시킵니다.
    -   Sec-WebSocket-Accept 헤더에 클라이언트에서 보낸 Sec-WebSocket-Key 값을 포함시킨 후, SHA-1 해시를 적용한 결과를 포함시킵니다.
```

2. Data Transfer

- Opening HandShake가 승인이 되면 진행이 됨.
- 데이터는 메시지라는 단위로 전달 됨 (프레임이 모여 구성되는 하나의 메시지 단위)
- 프레임- 통신에서 가장 단위의 데이터 (데이터 링크 계층 ) - 작은 헤더 + payload
- Handshake가 끝난 시점부터 서버와 클라이언트는 서로가 살아 있는지 확인하기 위해 heartbeat 패킷을 보내며, 주기적으로 ping을 보내 체크한다. 이는 서버와 클라이언트 양측에서 설정 가능하다.

3. Close Handshake

- 클라이언트와 서버 모두 커넥션을 종료하기 위한 컨트롤 프레임을 전송할 수 있다.
- 이 컨트롤 프레임은 Closing Handshake를 시작하라는 특정한 컨트롤 시퀀스를 포함한 데이터를 가지고 있다.
- 서버가 커넥션을 종료한다는 프레임을 보내고, 클라이언트가 이에 대한 응답으로 Close 프레임을 전송하면 웹소켓 연결이 종료된다.
- 연결 종료 이후에 수신되는 모든 추가적인 데이터는 버려진다.
